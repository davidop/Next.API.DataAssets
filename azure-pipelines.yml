trigger:
- main

pr:
- main

pool:
  vmImage: 'windows-latest'

variables:
  BuildConfiguration: 'Release'
  DotNetVersion: '8.x'

stages:
- stage: BuildAndTest
  displayName: Build and Test
  jobs:
  - job: build_test
    displayName: Build/Test/Publish
    steps:
    - checkout: self

    - task: UseDotNet@2
      displayName: 'Use .NET SDK'
      inputs:
        packageType: 'sdk'
        version: '$(DotNetVersion)'

    - script: dotnet restore Next.API.DataAssets.sln
      displayName: Restore

    - script: dotnet build Next.API.DataAssets.sln -c $(BuildConfiguration) --no-restore
      displayName: Build

    - script: dotnet test Next.API.DataAssets.sln -c $(BuildConfiguration) --no-build --logger "trx;LogFileName=test_results.trx"
      displayName: Test

    - task: PublishTestResults@2
      displayName: 'Publish test results'
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/*.trx'
        failTaskOnFailedTests: true

    - script: dotnet publish src/Next.API.DataAssets/Next.API.DataAssets.csproj -c $(BuildConfiguration) -o $(Build.ArtifactStagingDirectory)\publish
      displayName: Publish

    - task: PublishBuildArtifacts@1
      displayName: 'Publish artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)\publish'
        ArtifactName: 'publish'
        publishLocation: 'Container'

# Optional deploy stage: requires a self-hosted Windows agent on the IIS server.
# Enable by creating an Environment and a self-hosted agent, then set runDeploy=true.
- stage: DeployToIIS
  displayName: Deploy to IIS (Self-hosted)
  dependsOn: BuildAndTest
  condition: and(succeeded(), eq(variables['runDeploy'], 'true'))
  jobs:
  - deployment: deploy_iis
    displayName: Deploy
    environment: 'iis-prod'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: publish

          - powershell: |
              $dest = "$(IISPhysicalPath)"
              $appPool = "$(IISAppPoolName)"
              $src = "$(Pipeline.Workspace)\publish"

              Import-Module WebAdministration
              New-Item -ItemType Directory -Force -Path $dest | Out-Null

              if (Test-Path "IIS:\AppPools\$appPool") {
                Stop-WebAppPool -Name $appPool -ErrorAction SilentlyContinue
              }

              robocopy $src $dest /MIR /R:2 /W:2 | Out-Null

              if (-not (Test-Path (Join-Path $dest "web.config"))) {
                Copy-Item -Force "$(System.DefaultWorkingDirectory)\deploy\web.config" (Join-Path $dest "web.config")
              }

              if (Test-Path "IIS:\AppPools\$appPool") {
                Start-WebAppPool -Name $appPool -ErrorAction SilentlyContinue
              }
            displayName: 'Deploy files to IIS'
